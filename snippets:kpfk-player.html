<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPFK Player</title>
    <style>
     /* Fixed player styles */
        .kp-loading {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .kpfk-player, #kpfk-player {
            max-width: 100%; /* Changed from 799px to 100% */
            width: 100%;
            margin: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            font-family: Georgia, 'Times New Roman', serif;
            box-sizing: border-box;
            display: block;
            position: relative;
            clear: both;
            float: none;
        }

        /* Defensive CSS to prevent layout breaking */
        .kpfk-player *, #kpfk-player * {
            box-sizing: border-box;
            max-width: 100%;
        }

        .kpfk-player {
            contain: layout style; /* Added style containment */
        }

        /* Sticky player controls */
        .kp-controls.sticky {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            max-width: none !important;
        }

        .kp-header {
            display: flex;
            padding: 16px;
            background: #cc0000;
            color: white;
            border-bottom: 2px solid #990000;
            position: relative;
        }

        .kp-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
        }

        .kp-img {
            margin-right: 15px;
            flex-shrink: 0;
        }

        .kp-img img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }

        .kp-info {
            flex: 1;
            min-width: 0; /* Prevent flex item overflow */
        }

        .kp-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 4px;
            font-family: Georgia, 'Times New Roman', serif;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .kp-subtitle {
            opacity: 0.9;
            font-size: 0.85rem;
            font-style: italic;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.3px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .kp-episodes {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .kp-episode {
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .kp-episode:hover {
            background-color: #f8fafc;
        }

        .kp-episode.playing {
            background-color: #fff5f5;
            border-left: 4px solid #cc0000;
        }

        .kp-row {
            display: flex;
            align-items: flex-start;
            padding: 12px 16px;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .kp-play {
            background: #cc0000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 12px;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .kp-play::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .kp-play:hover {
            background: #990000;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(204, 0, 0, 0.3);
        }

        .kp-play:hover::before {
            left: 100%;
        }

        .kp-play svg {
            width: 16px;
            height: 16px;
            z-index: 1;
        }

        .kp-details {
            flex: 1;
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }

        .kp-ep-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #222;
            line-height: 1.4;
            font-size: 0.95rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .kp-meta {
            color: #6b7280;
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .kp-desc-wrapper {
            margin-bottom: 10px;
        }

        .kp-desc {
            color: #4b5563;
            font-size: 0.9rem;
            line-height: 1.5;
            max-height: 3.6em;
            overflow: hidden;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .kp-desc.expanded {
            max-height: none;
        }

        .kp-read-more {
            background: none;
            border: none;
            color: #cc0000;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0;
            margin-top: 4px;
            text-decoration: underline;
        }

        .kp-ep-actions {
            margin-top: 8px;
        }

        .kp-download {
            background: none;
            border: 1px solid #ccc;
            color: #666;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            font-family: Georgia, 'Times New Roman', serif;
        }

        .kp-download:hover {
            background: #f5f5f5;
            border-color: #999;
            color: #cc0000;
        }

        .kp-download svg {
            width: 14px;
            height: 14px;
        }

        .kp-now-playing {
            display: none;
            color: #cc0000;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 6px;
            animation: pulse 2s infinite;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .kp-now-playing::before {
            content: '◉ ';
            color: #cc0000;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .kp-now-playing.active {
            display: block;
        }

        .kp-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f8f8;
            border-top: 1px solid #e0e0e0;
        }

        .kp-page-info {
            color: #6b7280;
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.2px;
        }

        .kp-page-btns {
            display: flex;
            gap: 10px;
        }

        .kp-page-btn {
            background: #cc0000;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }

        .kp-page-btn:hover:not(:disabled) {
            background: #990000;
        }

        .kp-page-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .kp-controls {
            display: none;
            background: #2a2a2a;
            color: white;
            padding: 12px 16px;
        }

        .kp-controls.active {
            display: block;
        }

        .kp-current-info {
            margin-bottom: 12px;
        }

        .kp-current-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .kp-current-date {
            color: #ccc;
            font-size: 0.75rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .kp-progress {
            background: #444;
            height: 3px;
            border-radius: 1px;
            margin-bottom: 12px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .kp-progress::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 8px,
                rgba(255,255,255,0.1) 8px,
                rgba(255,255,255,0.1) 9px
            );
            pointer-events: none;
        }

        .kp-progress-fill {
            background: #cc0000;
            height: 100%;
            width: 0%;
            transition: width 0.1s;
            position: relative;
        }

        .kp-progress-fill::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 8px;
            background: #fff;
            border-radius: 1px;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }

        .kp-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            max-width: 100%;
        }

        .kp-playback-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kp-control-play {
            background: #cc0000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kp-control-play:hover {
            background: #990000;
            transform: scale(1.05);
        }

        .kp-control-play svg {
            width: 18px;
            height: 18px;
        }

        .kp-skip {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kp-skip:hover {
            color: white;
        }

        .kp-skip svg {
            width: 20px;
            height: 20px;
        }

        .kp-time {
            color: #ccc;
            font-size: 0.8rem;
            font-family: 'Courier New', monospace;
            white-space: nowrap;
        }

        .kp-speeds {
            display: flex;
            gap: 5px;
        }

        .kp-speed {
            background: none;
            border: 1px solid #555;
            color: #ccc;
            padding: 3px 6px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .kp-speed:hover {
            border-color: #777;
            color: white;
        }

        .kp-speed.active {
            background: #cc0000;
            border-color: #cc0000;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 799px) {
            .kp-header {
                flex-direction: column;
                text-align: center;
                padding: 12px;
            }
            
            .kp-img {
                margin: 0 auto 10px;
            }
            
            .kp-row {
                padding: 10px 12px;
                flex-wrap: wrap;
            }
            
            .kp-bottom {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .kp-playback-controls {
                justify-content: center;
            }
            
            .kp-speeds {
                order: 3;
                width: 100%;
                justify-content: center;
            }
            
            .kp-pagination {
                padding: 10px 12px;
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .kp-page-btns {
                justify-content: center;
            }
            
            .kp-controls.sticky {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
            }
        }

        /* Body padding to prevent sticky player overlap */
        body.player-active {
            padding-bottom: 120px;
        }
    </style>
</head>
<body>
    <!-- Test different show codes -->
    <div id="kpfk-player-letters" data-show="letters"></div>

    <script>
        // KPFK Player - MINIMAL FIX VERSION (keeping original working functionality)
        class KPFKPlayer {
            constructor(containerId = 'kpfk-player', options = {}) {
                this.audio = null;
                this.episode = null;
                this.playing = false;
                this.episodes = [];
                this.currentPage = 1;
                this.autoplayNext = true;
                this.episodesPerPage = 6;
                this.loading = false;
                this.showsCache = null;
                this.stickyPlayer = false;
                
                // Get container
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.error(`KPFK Player: Container #${containerId} not found`);
                    return;
                }
                
                this.init(options);
            }

            async init(options = {}) {
                console.log('KPFK Player: Starting initialization...');
                this.container.innerHTML = '<div class="kp-loading">Loading shows and episodes...</div>';
                
                try {
                    await this.loadShowsData();
                    
                    // RESTORED: Use original show code determination logic
                    this.showCode = await this.determineShowCode(options);
                    console.log('KPFK Player: Show code determined:', this.showCode);
                    
                    await this.loadShowInfo();
                    await this.loadEpisodes();
                    
                    this.render();
                    this.bind();
                    this.cacheElements();
                    
                    console.log('KPFK Player: Initialization complete!');
                } catch (e) {
                    console.error('KPFK Player: Failed to load:', e);
                    this.container.innerHTML = '<div class="kp-loading">Failed to load shows data. Please try again.</div>';
                }
            }

            async determineShowCode(options = {}) {
                const keyEl = document.getElementById('show-key');
                if (keyEl && keyEl.textContent.trim()) {
                    return keyEl.textContent.trim();
                }

                console.error('KPFK Player: Show key not found in #show-key element.');
                return null;
            }

            async extractAndMapShowFromURL() {
                const path = window.location.pathname;
                const match = path.match(/\/on-air\/([^\/]+)\/?$/);
                
                if (match) {
                    const urlSlug = match[1];
                    return this.mapSlugToShowCode(urlSlug);
                }
                
                return null;
            }

            mapSlugToShowCode(urlSlug) {
                if (!this.showsCache?.shows || !Array.isArray(this.showsCache.shows)) {
                    return null;
                }
                
                const shows = this.showsCache.shows;
                const normalizedSlug = this.normalizeSlug(urlSlug);
                
                const specialMappings = this.getSpecialMappings(normalizedSlug);
                if (specialMappings) {
                    return specialMappings;
                }
                
                for (const show of shows) {
                    if (show.sh_altid && show.sh_altid.toLowerCase() === normalizedSlug) {
                        return show.sh_altid;
                    }
                }
                
                for (const show of shows) {
                    if (show.sh_name) {
                        const normalizedName = this.normalizeSlug(show.sh_name);
                        if (normalizedName === normalizedSlug) {
                            return show.sh_altid;
                        }
                    }
                }
                
                return null;
            }

            getSpecialMappings(normalizedSlug) {
                const specialCases = {
                    'democracy-now-am': 'dn',
                    'democracy-now-pm': 'dnpm',
                    'informativo-pacifica': 'informap',
                };
                
                return specialCases[normalizedSlug] || null;
            }

            normalizeSlug(text) {
                return text.toLowerCase()
                    .replace(/&[^;]+;/g, '')
                    .replace(/[^\w\s-]/g, '')
                    .replace(/[-_\s]+/g, '-')
                    .replace(/^the-/, '')
                    .replace(/-show$/, '')
                    .replace(/-program$/, '')
                    .replace(/^-+|-+$/g, '');
            }

            async loadShowsData() {
                if (this.showsCache && this.showsCache.timestamp > Date.now() - 3600000) {
                    return;
                }

                try {
                    const response = await fetch('https://confessor.kpfk.org/_nu_do_api.php?req=getalfa&json=1');
                    const data = await response.text();
                    
                    // Simple fix: just try to parse, if it fails use empty array
                    let shows = [];
                    try {
                        shows = JSON.parse(data);
                    } catch (parseError) {
                        console.warn('KPFK Player: API returned invalid JSON, continuing anyway');
                    }
                    
                    this.showsCache = {
                        shows: shows,
                        timestamp: Date.now()
                    };
                    
                    console.log('KPFK Player: Loaded', shows?.length || 0, 'shows from API');
                } catch (e) {
                    console.error('KPFK Player: Failed to load shows data from API:', e);
                    this.showsCache = { shows: [], timestamp: Date.now() };
                }
            }

            async loadShowInfo() {
                if (this.showCode === 'recent') {
                    this.showInfo = {
                        title: 'KPFK Archives',
                        subtitle: 'Streaming from archive.kpfk.org • Listener-powered radio',
                        image: null,
                        djname: 'KPFK'
                    };
                    return;
                }

                try {
                    const response = await fetch(`https://confessor.kpfk.org/_nu_do_api.php?req=key&key=${this.showCode}&json=1`);
                    const data = await response.text();
                    
                    let showData = null;
                    try {
                        showData = JSON.parse(data);
                    } catch (parseError) {
                        console.warn('KPFK Player: Show info API returned invalid JSON');
                    }
                    
                    this.showInfo = showData?.sh_name ? {
                        title: showData.sh_name,
                        subtitle: this.formatShowSchedule(showData),
                        image: showData.sh_photo ? `https://confessor.kpfk.org/pix/${showData.sh_photo}` : null,
                        djname: showData.sh_djname || ''
                    } : this.getDefaultShowInfo();
                } catch (e) {
                    console.error('Failed to load show info:', e);
                    this.showInfo = this.getDefaultShowInfo();
                }
            }

            formatShowSchedule(showData) {
                if (!showData.sh_days || !showData.sh_ampm) return 'Recent Episodes';
                return `${showData.sh_days} • ${showData.sh_ampm}`;
            }

            getDefaultShowInfo() {
                return { 
                    title: this.showCode === 'recent' ? 'KPFK Archives' : 'KPFK Show', 
                    subtitle: this.showCode === 'recent' ? 'Streaming from archive.kpfk.org • Listener-powered radio' : 'Recent Episodes'
                };
            }

            async loadEpisodes() {
                if (this.showCode === 'recent') {
                    await this.loadRecentEpisodes();
                    return;
                }

                try {
                    const response = await fetch(`https://confessor.kpfk.org/_nu_do_api.php?req=fil&id=${this.showCode}&num=50&json=1`);
                    const data = await response.text();
                    
                    let episodes = [];
                    try {
                        episodes = JSON.parse(data);
                    } catch (parseError) {
                        console.warn('KPFK Player: Episodes API returned invalid JSON');
                    }
                    
                    this.episodes = [];
                    
                    if (Array.isArray(episodes)) {
                        episodes.forEach(item => {
                            if (!item.mp3) return;
                            
                            let date = 'Recent';
                            let episodeDate = '';
                            if (item.date) {
                                date = item.date;
                                const dateObj = new Date(item.date);
                                episodeDate = dateObj.toLocaleDateString('en-US', {
                                    weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                                });
                            } else if (item.def_time) {
                                const d = new Date(item.def_time * 1000);
                                date = d.toLocaleDateString('en-US', {
                                    weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                                });
                                episodeDate = d.toLocaleDateString('en-US', {
                                    month: 'short', day: 'numeric', year: 'numeric'
                                });
                            }

                            let duration = '';
                            if (item.lsecs) {
                                const mins = Math.floor(item.lsecs / 60);
                                const secs = item.lsecs % 60;
                                duration = `${mins}:${secs.toString().padStart(2, '0')}`;
                            }

                            let description = '';
                            if (item.pubfile?.[0]) {
                                const pf = item.pubfile[0];
                                if (pf.pf_gname) description = pf.pf_gname;
                                if (pf.pf_gtopic && description) description += ' - ' + pf.pf_gtopic;
                                else if (pf.pf_gtopic) description = pf.pf_gtopic;
                            }

                            this.episodes.push({
                                title: item.title || `${this.showInfo.title} - ${episodeDate}`,
                                date,
                                episodeDate,
                                duration,
                                description: description || '',
                                audioUrl: this.fixAudioURL(item.mp3),
                                showName: this.showInfo.title
                            });
                        });
                    }
                } catch (e) {
                    console.error('Failed to load episodes:', e);
                    this.episodes = [];
                }
            }

            async loadRecentEpisodes() {
                const popularShowCodes = [
                    'letters',
                    'sojourner',
                    'dn',
                    'hartmann',
                    'backgroundbriefing',
                    'informap'
                ];
                const allEpisodes = [];
                
                for (const showCode of popularShowCodes) {
                    try {
                        const response = await fetch(`https://confessor.kpfk.org/_nu_do_api.php?req=fil&id=${showCode}&num=5&json=1`);
                        const data = await response.text();
                        
                        let episodes = [];
                        try {
                            episodes = JSON.parse(data);
                        } catch (parseError) {
                            console.warn(`KPFK Player: Show ${showCode} API returned invalid JSON, skipping`);
                            continue;
                        }
                        
                        if (Array.isArray(episodes)) {
                            const showInfo = await this.getShowInfoByCode(showCode);
                            
                            episodes.forEach(item => {
                                if (!item.mp3) return;
                                
                                let date = 'Recent';
                                let episodeDate = '';
                                let timestamp = 0;
                                
                                if (item.date) {
                                    const dateObj = new Date(item.date);
                                    date = dateObj.toLocaleDateString('en-US', {
                                        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                                    });
                                    episodeDate = dateObj.toLocaleDateString('en-US', {
                                        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                                    });
                                    timestamp = dateObj.getTime();
                                } else if (item.def_time) {
                                    const d = new Date(item.def_time * 1000);
                                    date = d.toLocaleDateString('en-US', {
                                        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                                    });
                                    episodeDate = d.toLocaleDateString('en-US', {
                                        month: 'short', day: 'numeric', year: 'numeric'
                                    });
                                    timestamp = d.getTime();
                                }

                                allEpisodes.push({
                                    title: item.title || `${showInfo.title} - ${episodeDate}`,
                                    date,
                                    episodeDate,
                                    duration: item.lsecs ? `${Math.floor(item.lsecs / 60)}:${(item.lsecs % 60).toString().padStart(2, '0')}` : '',
                                    description: '',
                                    audioUrl: this.fixAudioURL(item.mp3),
                                    showName: showInfo.title,
                                    timestamp
                                });
                            });
                        }
                    } catch (e) {
                        console.warn(`Failed to load episodes for ${showCode}:`, e);
                    }
                }
                
                this.episodes = allEpisodes
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 30);
            }

            async getShowInfoByCode(showCode) {
                try {
                    const response = await fetch(`https://confessor.kpfk.org/_nu_do_api.php?req=key&key=${showCode}&json=1`);
                    const data = await response.text();
                    
                    let showData = null;
                    try {
                        showData = JSON.parse(data);
                    } catch (parseError) {
                        // Just return fallback if JSON parsing fails
                        return { title: showCode };
                    }
                    
                    return { title: showData?.sh_name || showCode };
                } catch (e) {
                    return { title: showCode };
                }
            }

            fixAudioURL(url) {
                if (!url) return null;
                
                if (url.includes('confessor.kpfk.org/home/kpfkarch/public_html/mp3/')) {
                    const filename = url.split('/mp3/')[1];
                    return filename ? `https://archive.kpfk.org/mp3/${filename}` : url;
                }
                
                return url;
            }

            render() {
                const info = this.showInfo || this.getDefaultShowInfo();
                const totalPages = Math.ceil(this.episodes.length / this.episodesPerPage);
                const start = (this.currentPage - 1) * this.episodesPerPage;
                const pageEpisodes = this.episodes.slice(start, start + this.episodesPerPage);

                const container = document.getElementById(this.container.id);
                container.innerHTML = '';

                const header = document.createElement('div');
                header.className = 'kp-header';
                
                if (info.image) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'kp-img';
                    const img = document.createElement('img');
                    img.src = info.image;
                    img.alt = info.title;
                    img.onerror = function() { this.parentElement.style.display = 'none'; };
                    imgDiv.appendChild(img);
                    header.appendChild(imgDiv);
                }
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'kp-info';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'kp-title';
                titleDiv.textContent = info.title;
                
                const subtitleDiv = document.createElement('div');
                subtitleDiv.className = 'kp-subtitle';
                subtitleDiv.textContent = info.subtitle;
                
                infoDiv.appendChild(titleDiv);
                infoDiv.appendChild(subtitleDiv);
                header.appendChild(infoDiv);
                container.appendChild(header);

                const episodesDiv = document.createElement('div');
                episodesDiv.className = 'kp-episodes';
                
                if (pageEpisodes.length > 0) {
                    pageEpisodes.forEach((ep, i) => {
                        const episodeDiv = document.createElement('div');
                        episodeDiv.className = 'kp-episode';
                        episodeDiv.setAttribute('data-index', start + i);
                        
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'kp-row';
                        
                        const playBtn = document.createElement('button');
                        playBtn.className = 'kp-play';
                        playBtn.setAttribute('aria-label', 'Play episode: ' + ep.title);
                        playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                        
                        const detailsDiv = document.createElement('div');
                        detailsDiv.className = 'kp-details';
                        
                        const epTitle = document.createElement('div');
                        epTitle.className = 'kp-ep-title';
                        epTitle.textContent = ep.title;
                        
                        const metaDiv = document.createElement('div');
                        metaDiv.className = 'kp-meta';
                        metaDiv.textContent = ep.date + (ep.duration ? ' • ' + ep.duration : '');
                        
                        if (this.showCode === 'recent' && ep.showName) {
                            metaDiv.textContent += ' • ' + ep.showName;
                        }
                        
                        detailsDiv.appendChild(epTitle);
                        detailsDiv.appendChild(metaDiv);
                        
                        if (ep.description) {
                            const descWrapper = document.createElement('div');
                            descWrapper.className = 'kp-desc-wrapper';
                            
                            const descDiv = document.createElement('div');
                            descDiv.className = 'kp-desc';
                            descDiv.textContent = ep.description;
                            
                            descWrapper.appendChild(descDiv);
                            
                            if (ep.description.length > 150) {
                                const readMoreBtn = document.createElement('button');
                                readMoreBtn.className = 'kp-read-more';
                                readMoreBtn.textContent = 'Read more...';
                                descWrapper.appendChild(readMoreBtn);
                            }
                            
                            detailsDiv.appendChild(descWrapper);
                        }
                        
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'kp-ep-actions';
                        
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'kp-download';
                        downloadBtn.setAttribute('data-url', ep.audioUrl);
                        downloadBtn.setAttribute('data-title', ep.title);
                        downloadBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Download';
                        
                        actionsDiv.appendChild(downloadBtn);
                        detailsDiv.appendChild(actionsDiv);
                        
                        const nowPlaying = document.createElement('div');
                        nowPlaying.className = 'kp-now-playing';
                        nowPlaying.textContent = '♪ Now Playing';
                        detailsDiv.appendChild(nowPlaying);
                        
                        rowDiv.appendChild(playBtn);
                        rowDiv.appendChild(detailsDiv);
                        episodeDiv.appendChild(rowDiv);
                        episodesDiv.appendChild(episodeDiv);
                    });
                } else {
                    const noEps = document.createElement('div');
                    noEps.className = 'kp-episode';
                    noEps.innerHTML = '<div class="kp-details">No episodes available</div>';
                    episodesDiv.appendChild(noEps);
                }
                
                container.appendChild(episodesDiv);

                if (totalPages > 1) {
                    const paginationDiv = document.createElement('div');
                    paginationDiv.className = 'kp-pagination';
                    
                    const pageInfo = document.createElement('div');
                    pageInfo.className = 'kp-page-info';
                    pageInfo.textContent = 'Page ' + this.currentPage + ' of ' + totalPages + ' • ' + this.episodes.length + ' episodes';
                    
                    const pageBtns = document.createElement('div');
                    pageBtns.className = 'kp-page-btns';
                    
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'kp-page-btn';
                    prevBtn.setAttribute('data-action', 'prev');
                    prevBtn.textContent = '← Previous';
                    if (this.currentPage === 1) prevBtn.disabled = true;
                    
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'kp-page-btn';
                    nextBtn.setAttribute('data-action', 'next');
                    nextBtn.textContent = 'Next →';
                    if (this.currentPage === totalPages) nextBtn.disabled = true;
                    
                    pageBtns.appendChild(prevBtn);
                    pageBtns.appendChild(nextBtn);
                    paginationDiv.appendChild(pageInfo);
                    paginationDiv.appendChild(pageBtns);
                    container.appendChild(paginationDiv);
                }

                this.createControls(container);
            }

            createControls(container) {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'kp-controls';
                
                const currentInfo = document.createElement('div');
                currentInfo.className = 'kp-current-info';
                
                const currentTitle = document.createElement('div');
                currentTitle.className = 'kp-current-title';
                
                const currentDate = document.createElement('div');
                currentDate.className = 'kp-current-date';
                
                currentInfo.appendChild(currentTitle);
                currentInfo.appendChild(currentDate);
                
                const progress = document.createElement('div');
                progress.className = 'kp-progress';
                
                const progressFill = document.createElement('div');
                progressFill.className = 'kp-progress-fill';
                progress.appendChild(progressFill);
                
                const bottom = document.createElement('div');
                bottom.className = 'kp-bottom';
                
                const playbackControls = document.createElement('div');
                playbackControls.className = 'kp-playback-controls';
                
                const skipBack = document.createElement('button');
                skipBack.className = 'kp-skip';
                skipBack.setAttribute('data-skip', '-15');
                skipBack.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 5V1l-5 5 5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6h-2c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/><text x="12" y="16" text-anchor="middle" font-size="8" fill="currentColor">15</text></svg>';
                
                const mainPlay = document.createElement('button');
                mainPlay.className = 'kp-control-play';
                mainPlay.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                
                const skipForward = document.createElement('button');
                skipForward.className = 'kp-skip';
                skipForward.setAttribute('data-skip', '30');
                skipForward.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.01 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z"/><text x="12" y="16" text-anchor="middle" font-size="8" fill="currentColor">30</text></svg>';
                
                playbackControls.appendChild(skipBack);
                playbackControls.appendChild(mainPlay);
                playbackControls.appendChild(skipForward);
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'kp-time';
                
                const currentSpan = document.createElement('span');
                currentSpan.className = 'kp-current';
                currentSpan.textContent = '0:00';
                
                const totalSpan = document.createElement('span');
                totalSpan.className = 'kp-total';
                totalSpan.textContent = '0:00';
                
                timeDiv.appendChild(currentSpan);
                timeDiv.appendChild(document.createTextNode(' / '));
                timeDiv.appendChild(totalSpan);
                
                const speedsDiv = document.createElement('div');
                speedsDiv.className = 'kp-speeds';
                
                const speeds = ['0.75', '1', '1.25', '1.5'];
                speeds.forEach(speed => {
                    const speedBtn = document.createElement('button');
                    speedBtn.className = 'kp-speed';
                    if (speed === '1') speedBtn.classList.add('active');
                    speedBtn.setAttribute('data-speed', speed);
                    speedBtn.textContent = speed + '×';
                    speedsDiv.appendChild(speedBtn);
                });
                
                bottom.appendChild(playbackControls);
                bottom.appendChild(timeDiv);
                bottom.appendChild(speedsDiv);
                
                controlsDiv.appendChild(currentInfo);
                controlsDiv.appendChild(progress);
                controlsDiv.appendChild(bottom);
                
                container.appendChild(controlsDiv);
            }

            bind() {
                this.unbind();
                
                const playButtons = this.container.querySelectorAll('.kp-play');
                playButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => this.play(e));
                });

                const controlPlay = this.container.querySelector('.kp-control-play');
                if (controlPlay) {
                    controlPlay.addEventListener('click', () => this.togglePlayback());
                }

                const skipButtons = this.container.querySelectorAll('.kp-skip');
                skipButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => this.skip(e));
                });

                const progress = this.container.querySelector('.kp-progress');
                if (progress) {
                    progress.addEventListener('click', (e) => this.seek(e));
                }

                const speedButtons = this.container.querySelectorAll('.kp-speed');
                speedButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => this.setSpeed(e));
                });

                const pageButtons = this.container.querySelectorAll('.kp-page-btn');
                pageButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => this.paginate(e));
                });

                const readMoreButtons = this.container.querySelectorAll('.kp-read-more');
                readMoreButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => this.toggleDescription(e));
                });

                const downloadButtons = this.container.querySelectorAll('.kp-download');
                downloadButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => this.downloadEpisode(e));
                });
            }

            unbind() {
                const elements = [
                    '.kp-play', '.kp-control-play', '.kp-skip', '.kp-progress', 
                    '.kp-speed', '.kp-page-btn', '.kp-read-more', '.kp-download'
                ];
                
                elements.forEach(selector => {
                    const items = this.container.querySelectorAll(selector);
                    items.forEach(item => {
                        item.replaceWith(item.cloneNode(true));
                    });
                });
            }

            cacheElements() {
                this.controls = this.container.querySelector('.kp-controls');
                this.progressFill = this.container.querySelector('.kp-progress-fill');
                this.currentTime = this.container.querySelector('.kp-current');
                this.totalTime = this.container.querySelector('.kp-total');
                this.controlPlay = this.container.querySelector('.kp-control-play');
            }

            downloadEpisode(e) {
                const btn = e.target.closest('.kp-download');
                const url = btn.dataset.url;
                const title = btn.dataset.title;
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.mp3`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            toggleDescription(e) {
                const btn = e.target;
                const wrapper = btn.closest('.kp-desc-wrapper');
                const desc = wrapper.querySelector('.kp-desc');
                
                if (desc.classList.contains('expanded')) {
                    desc.classList.remove('expanded');
                    btn.textContent = 'Read more...';
                } else {
                    desc.classList.add('expanded');
                    btn.textContent = 'Read less';
                }
            }

            togglePlayback() {
                if (!this.audio) return;
                this.audio.paused ? this.audio.play() : this.audio.pause();
            }

            skip(e) {
                if (!this.audio) return;
                const seconds = parseInt(e.target.closest('.kp-skip').dataset.skip);
                this.audio.currentTime += seconds;
            }

            play(e) {
                const btn = e.target.closest('.kp-play');
                const episode = btn.closest('.kp-episode');
                const index = parseInt(episode.dataset.index);
                const ep = this.episodes[index];

                if (this.episode === episode && this.audio) {
                    this.audio.paused ? this.audio.play() : this.audio.pause();
                    return;
                }

                if (this.audio) {
                    this.audio.pause();
                    this.reset();
                }

                this.episode = episode;
                this.currentIndex = index;
                this.currentEpisode = ep;
                episode.classList.add('playing');
                
                this.updateCurrentInfo(ep);
                
                this.audio = new Audio(ep.audioUrl);
                this.setupAudio(btn);
                this.audio.play();
            }

            updateCurrentInfo(ep) {
                const currentTitle = this.container.querySelector('.kp-current-title');
                const currentDate = this.container.querySelector('.kp-current-date');
                if (currentTitle) currentTitle.textContent = ep.title;
                if (currentDate) currentDate.textContent = ep.episodeDate;
            }

            setupAudio(btn) {
                this.audio.onloadstart = () => {
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                };
                
                this.audio.onplay = () => {
                    this.playing = true;
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                    if (this.controlPlay) {
                        this.controlPlay.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                    }
                    
                    this.showControls();
                    this.makeControlsSticky();
                    this.episode.querySelector('.kp-now-playing').classList.add('active');
                };

                this.audio.onpause = () => {
                    this.playing = false;
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                    if (this.controlPlay) {
                        this.controlPlay.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                    }
                    if (this.episode) {
                        this.episode.querySelector('.kp-now-playing').classList.remove('active');
                    }
                };

                this.audio.ontimeupdate = () => this.updateProgress();

                this.audio.onended = () => {
                    if (this.autoplayNext && this.currentIndex < this.episodes.length - 1) {
                        this.playNext();
                    } else {
                        this.reset();
                    }
                };

                this.audio.onerror = () => {
                    btn.innerHTML = '❌';
                    setTimeout(() => this.reset(), 1000);
                };
            }

            makeControlsSticky() {
                if (this.controls && !this.stickyPlayer) {
                    this.controls.classList.add('sticky');
                    document.body.classList.add('player-active');
                    this.stickyPlayer = true;
                }
            }

            playNext() {
                const nextIndex = this.currentIndex + 1;
                const nextEpisode = document.querySelector(`[data-index="${nextIndex}"]`);
                if (nextEpisode) {
                    const btn = nextEpisode.querySelector('.kp-play');
                    this.play({ target: btn });
                }
            }

            showControls() {
                if (this.controls) {
                    this.controls.classList.add('active');
                }
            }

            updateProgress() {
                if (!this.audio?.duration) return;
                
                const percent = (this.audio.currentTime / this.audio.duration) * 100;
                
                if (this.progressFill) {
                    this.progressFill.style.width = `${percent}%`;
                }
                if (this.currentTime) {
                    this.currentTime.textContent = this.formatTime(this.audio.currentTime);
                }
                if (this.totalTime) {
                    this.totalTime.textContent = this.formatTime(this.audio.duration);
                }
            }

            seek(e) {
                if (!this.audio?.duration) return;
                const rect = e.target.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                this.audio.currentTime = percent * this.audio.duration;
            }

            setSpeed(e) {
                const btn = e.target;
                const speed = parseFloat(btn.dataset.speed);
                if (this.audio) this.audio.playbackRate = speed;
                
                this.container.querySelectorAll('.kp-speed').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            async paginate(e) {
                if (this.loading) return;
                
                const action = e.target.dataset.action;
                const totalPages = Math.ceil(this.episodes.length / this.episodesPerPage);
                
                if (action === 'next' && this.currentPage < totalPages) {
                    this.currentPage++;
                } else if (action === 'prev' && this.currentPage > 1) {
                    this.currentPage--;
                } else {
                    return;
                }
                
                this.loading = true;
                
                const wasPlaying = this.playing;
                const currentAudio = this.audio;
                const currentTime = this.audio ? this.audio.currentTime : 0;
                const currentEpisodeData = this.currentEpisode;
                
                await new Promise(resolve => setTimeout(resolve, 150));
                
                this.render();
                this.bind();
                this.cacheElements();
                
                if (currentAudio && currentEpisodeData) {
                    const playingIndex = this.episodes.indexOf(currentEpisodeData);
                    const playingEpisode = this.container.querySelector(`[data-index="${playingIndex}"]`);
                    
                    if (playingEpisode) {
                        playingEpisode.classList.add('playing');
                        const btn = playingEpisode.querySelector('.kp-play');
                        if (wasPlaying) {
                            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                            playingEpisode.querySelector('.kp-now-playing').classList.add('active');
                        }
                        this.episode = playingEpisode;
                    }
                    
                    this.audio = currentAudio;
                    this.currentEpisode = currentEpisodeData;
                    this.playing = wasPlaying;
                    
                    if (currentTime) {
                        currentAudio.currentTime = currentTime;
                    }
                    
                    this.updateCurrentInfo(currentEpisodeData);
                    this.showControls();
                    this.makeControlsSticky();
                }
                
                this.loading = false;
            }

            reset() {
                this.container.querySelectorAll('.kp-episode').forEach(ep => {
                    ep.classList.remove('playing');
                    const nowPlaying = ep.querySelector('.kp-now-playing');
                    if (nowPlaying) nowPlaying.classList.remove('active');
                });
                
                this.container.querySelectorAll('.kp-play').forEach(btn => {
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                });
                
                if (this.controls) {
                    this.controls.classList.remove('active');
                    this.controls.classList.remove('sticky');
                }
                document.body.classList.remove('player-active');
                this.stickyPlayer = false;
                
                const currentTitle = this.container.querySelector('.kp-current-title');
                const currentDate = this.container.querySelector('.kp-current-date');
                if (currentTitle) currentTitle.textContent = '';
                if (currentDate) currentDate.textContent = '';
                
                this.audio = null;
                this.episode = null;
                this.playing = false;
                this.currentEpisode = null;
            }

            formatTime(seconds) {
                if (!seconds || !isFinite(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // Auto-initialization
        function initKPFKPlayers() {
            const defaultContainer = document.getElementById('kpfk-player');
            if (defaultContainer) {
                new KPFKPlayer('kpfk-player');
            }
            
            const playerContainers = document.querySelectorAll('[id^="kpfk-player-"]');
            playerContainers.forEach(container => {
                const showCode = container.id.replace('kpfk-player-', '');
                new KPFKPlayer(container.id, { show: showCode });
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initKPFKPlayers);
        } else {
            initKPFKPlayers();
        }

        window.createKPFKPlayer = function(containerId, options = {}) {
            return new KPFKPlayer(containerId, options);
        };
    </script>
</body>
</html>